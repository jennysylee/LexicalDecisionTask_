<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lexical Decision Task</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #ffffff;
      color: #000000;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    #container {
      max-width: 800px;
      margin: 0 auto;
    }
    .hidden {
      display: none !important;
    }
    .stimulus {
      font-family: Arial, sans-serif;
      font-size: 40px;
      font-weight: bold;
      line-height: 1.2;
      min-height: 60px;
    }
    #fixation {
      font-size: 60px;
      margin: 20px 0;
    }
    #word1 { margin-bottom: 10px; }
    #word2 { margin-top: 10px; }
    #feedback {
      color: green;
      font-size: 32px;
    }
    #feedback.error {
      color: red;
    }
    button {
      margin: 10px;
      font-size: 18px;
      padding: 12px 24px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button:hover {
      background-color: #f0f0f0;
    }
    input {
      font-size: 18px;
      padding: 10px;
      text-align: center;
      width: 100px;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Participant ID screen -->
    <div id="start-screen">
      <h1>Lexical Decision Task</h1>
      <p>Enter your 3-digit participant number (000â€“999):</p>
      <input type="text" id="participant-id" maxlength="3" pattern="[0-9]{3}">
      <br><br>
      <button id="start-btn">Start Experiment</button>
      <p id="id-error" class="error"></p>
    </div>

    <!-- Instructions -->
    <div id="instruction-screen" class="hidden">
      <h2>Instructions</h2>
      <p>After a fixation cross (+), two words appear.</p>
      <p>Decide if the <strong>second word</strong> is a real word (A key) or nonword (L key).</p>
      <p>Respond quickly and accurately! Max 2 seconds per trial.</p>
      <p>Press <strong>Spacebar</strong> to begin.</p>
    </div>

    <!-- Task display -->
    <div id="task-screen" class="hidden">
      <div id="fixation" class="stimulus"></div>
      <div id="word1" class="stimulus"></div>
      <div id="word2" class="stimulus"></div>
      <div id="feedback" class="stimulus"></div>
      <p style="font-size: 20px; margin-top: 20px;">
        Word: <strong>A</strong> | Nonword: <strong>L</strong>
      </p>
    </div>

    <!-- End screen -->
    <div id="end-screen" class="hidden">
      <h2>Task Complete!</h2>
      <p>Download your results or restart.</p>
      <div>
        <button id="download-btn">Download CSV</button>
        <button id="restart-btn">Restart Experiment</button>
      </div>
      <p id="download-info"></p>
    </div>
  </div>

  <script>
    // Stimuli (your table exactly)
    const trials = [
      {word1: "DOCTOR", word2: "NURSE", condition: "related", code: 1, correctKey: "a"},
      {word1: "DOCTOR", word2: "FLIPO", condition: "nonword", code: 3, correctKey: "l"},
      {word1: "TREE", word2: "DOCTOR", condition: "unrelated", code: 2, correctKey: "a"},
      {word1: "DOCTOR", word2: "NURSE", condition: "unrelated", code: 2, correctKey: "a"},
      {word1: "DOCTOR", word2: "FLIPO", condition: "nonword", code: 3, correctKey: "l"},
      {word1: "BUTTER", word2: "BREAD", condition: "related", code: 1, correctKey: "a"},
      {word1: "BREAD", word2: "DOCTOR", condition: "unrelated", code: 2, correctKey: "a"},
      {word1: "SOAM", word2: "GLOVE", condition: "nonword", code: 3, correctKey: "l"},
      {word1: "NART", word2: "TRIEF", condition: "nonword", code: 3, correctKey: "l"},
      {word1: "PLAME", word2: "WINE", condition: "nonword", code: 3, correctKey: "l"}
    ];

    // State
    let participantID = "";
    let currentTrialIndex = 0;
    let trialStartTime = 0;
    let responseDeadline = 2000;
    let keyListenerActive = false;
    let results = [];
    let globalKeyHandler = null;

    // Elements
    const screens = {
      start: document.getElementById("start-screen"),
      instructions: document.getElementById("instruction-screen"),
      task: document.getElementById("task-screen"),
      end: document.getElementById("end-screen")
    };
    const participantInput = document.getElementById("participant-id");
    const startBtn = document.getElementById("start-btn");
    const idError = document.getElementById("id-error");
    const fixationEl = document.getElementById("fixation");
    const word1El = document.getElementById("word1");
    const word2El = document.getElementById("word2");
    const feedbackEl = document.getElementById("feedback");
    const downloadBtn = document.getElementById("download-btn");
    const restartBtn = document.getElementById("restart-btn");
    const downloadInfo = document.getElementById("download-info");

    function showScreen(screenName) {
      Object.values(screens).forEach(s => s.classList.add("hidden"));
      screens[screenName].classList.remove("hidden");
    }

    function clearStimuli() {
      fixationEl.textContent = "";
      word1El.textContent = "";
      word2El.textContent = "";
      feedbackEl.textContent = "";
      feedbackEl.classList.remove("error");
    }

    function validateID(id) {
      return /^[0-9]{3}$/.test(id);
    }

    // Event listeners
    startBtn.onclick = () => {
      const id = participantInput.value.trim();
      if (!validateID(id)) {
        idError.textContent = "Enter valid 3-digit ID (000-999).";
        return;
      }
      participantID = id;
      idError.textContent = "";
      showScreen("instructions");
      // Single spacebar listener
      document.addEventListener("keydown", startTaskHandler, { once: true });
    };

    function startTaskHandler(e) {
      if (e.code !== "Space") return;
      showScreen("task");
      currentTrialIndex = 0;
      results = [];
      nextTrial();
    }

    function nextTrial() {
      if (currentTrialIndex >= trials.length) {
        showScreen("end");
        return;
      }
      clearStimuli();
      const trial = trials[currentTrialIndex];

      // Fixation 500ms
      fixationEl.textContent = "+";
      setTimeout(() => {
        // Blank 500ms
        setTimeout(() => {
          word1El.textContent = trial.word1;
          word2El.textContent = trial.word2;
          trialStartTime = performance.now();
          keyListenerActive = true;
          globalKeyHandler = keyResponse.bind(null, trial);
          document.addEventListener("keydown", globalKeyHandler);

          // Timeout
          setTimeout(() => {
            if (keyListenerActive) endTrial(null, null, "TOO_SLOW");
          }, responseDeadline);
        }, 500);
      }, 500);
    }

    function keyResponse(trial, e) {
      if (!keyListenerActive || (e.code !== "KeyA" && e.code !== "KeyL")) return;
      e.preventDefault();
      const key = e.code === "KeyA" ? "a" : "l";
      const rt = performance.now() - trialStartTime;
      endTrial(key, rt, null);
    }

    function endTrial(key, rt, statusOverride) {
      keyListenerActive = false;
      if (globalKeyHandler) {
        document.removeEventListener("keydown", globalKeyHandler);
        globalKeyHandler = null;
      }

      const trial = trials[currentTrialIndex];
      let status = statusOverride;
      if (!status) {
        status = (key === trial.correctKey) ? "CORRECT" : "INCORRECT";
      }

      if (status === "CORRECT") {
        feedbackEl.textContent = "Correct!";
        setTimeout(() => {
          recordTrial(trial, key, rt, status);
          currentTrialIndex++;
          nextTrial();
        }, 500);
      } else {
        feedbackEl.classList.add("error");
        feedbackEl.textContent = "Wrong or too slow!";
        setTimeout(() => {
          recordTrial(trial, key, rt, status);
          currentTrialIndex++;
          nextTrial();
        }, 1500);
      }
    }

    function recordTrial(trial, key, rt, status) {
      results.push({
        participant: participantID,
        blockname: "training",
        tablerow: currentTrialIndex + 1,
        word1: trial.word1,
        word2: trial.word2,
        condition: trial.condition,
        code: trial.code,
        key: key || "",
        rt: rt ? Math.round(rt) : "",
        status
      });
    }

    function generateCSV() {
      const headers = ["participant", "blockname", "tablerow", "word1", "word2", "condition", "code", "key", "rt", "status"];
      const csv = [headers, ...results.map(r => headers.map(h => `"${r[h] || ''}"`))].map(row => row.join(",")).join("\n");
      return "\uFEFF" + csv; // BOM for Excel compatibility
    }

    downloadBtn.onclick = () => {
      const csv = generateCSV();
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `lexical_${participantID}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      downloadInfo.textContent = "Downloaded: lexical_" + participantID + ".csv";
    };

    restartBtn.onclick = () => {
      participantID = "";
      currentTrialIndex = 0;
      results = [];
      keyListenerActive = false;
      if (globalKeyHandler) document.removeEventListener("keydown", globalKeyHandler);
      participantInput.value = "";
      idError.textContent = "";
      showScreen("start");
      participantInput.focus();
    };

    // Auto-focus ID input
    participantInput.focus();
  </script>
</body>
</html>
